---
title: "COVID-19 Tracking Data"
author: "Brian Gulbis, PharmD, BCPS"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
    html_document:
        code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Data source: www.covidtracking.com

```{r}
library(tidyverse)
library(themebg)

raw_state <- read_csv("https://covidtracking.com/api/states/daily.csv") %>%
    mutate_at("date", as.character) %>%
    mutate_at("date", parse_date, format = "%Y%m%d") %>%
    arrange(date, state)

raw_state_info <- read_csv("https://covidtracking.com/api/states/info.csv")

raw_usa <- read_csv("https://covidtracking.com/api/us/daily.csv") %>%
    mutate_at("date", as.character) %>%
    mutate_at("date", parse_date, format = "%Y%m%d") 

```

# USA

```{r, fig.cap="Positive cases in USA"}
raw_usa %>%
    ggplot(aes(x = date, y = positive)) +
    geom_line() +
    theme_bg() +
    theme(legend.position = "none")
```

```{r, fig.cap="Number of of new positive cases each day in USA"}
raw_usa %>%
    ggplot(aes(x = date, y = positiveIncrease)) +
    geom_line() +
    theme_bg()
```

```{r, fig.cap="Cummulative deaths in USA"}
raw_usa %>%
    ggplot(aes(x = date, y = death)) +
    geom_line() +
    theme_bg() +
    theme(legend.position = "none")
```

```{r, fig.cap="Number of new deaths each day in USA"}
raw_usa %>%
    ggplot(aes(x = date, y = deathIncrease)) +
    geom_line() +
    theme_bg()
```

# State

```{r, fig.cap="Positive cases by state"}
raw_state %>%
    ggplot(aes(x = date, y = positive, color = state)) +
    geom_line() +
    theme_bg() +
    theme(legend.position = "none")
```

```{r, fig.cap="Negative tests by state"}
raw_state %>%
    ggplot(aes(x = date, y = negative, color = state)) +
    geom_line() +
    theme_bg() +
    theme(legend.position = "none")
```

```{r, fig.cap="Total number of tests by state"}
raw_state %>%
    ggplot(aes(x = date, y = totalTestResults, color = state)) +
    geom_line() +
    theme_bg() +
    theme(legend.position = "none")
```

```{r, fig.cap="Number of deaths by state"}
raw_state %>%
    filter(!is.na(death)) %>%
    ggplot(aes(x = date, y = death, color = state)) +
    geom_line() +
    theme_bg() +
    theme(legend.position = "none")
```

```{r, fig.cap="Number of new positive cases each day by state"}
raw_state %>%
    ggplot(aes(x = date, y = positiveIncrease, color = state)) +
    geom_line() +
    theme_bg() +
    theme(legend.position = "none")
```

```{r, fig.cap="Number of new deaths each day by state"}
raw_state %>%
    ggplot(aes(x = date, y = deathIncrease, color = state)) +
    geom_line() +
    theme_bg() +
    theme(legend.position = "none")
```

# NY vs. Rest of USA

```{r}
df_us_ny <- raw_state %>%
    mutate(is_ny = state == "NY") %>%
    group_by(date, is_ny) %>%
    summarize_at(c("positive", "negative", "death"), sum, na.rm = TRUE) %>%
    mutate(tests = positive + negative) %>%
    group_by(is_ny) %>%
    mutate(
        positive_change = positive - lag(positive),
        negative_change = negative - lag(negative),
        death_change = death - lag(death),
        tests_change = tests - lag(tests),
        death_positive = death / positive
    )
```

```{r, fig.cap="Number of positive cases in NY vs. rest of USA"}
df_us_ny %>%
    ggplot(aes(x = date, y = positive, color = is_ny)) +
    geom_line() +
    theme_bg()
```

```{r, fig.cap="Number of negative tests in NY vs. rest of USA"}
df_us_ny %>%
    ggplot(aes(x = date, y = negative, color = is_ny)) +
    geom_line() +
    theme_bg()
```

```{r, fig.cap="Number of tests performed in NY vs. rest of USA"}
df_us_ny %>%
    ggplot(aes(x = date, y = tests, color = is_ny)) +
    geom_line() +
    theme_bg()
```

```{r, fig.cap="Number of deaths in NY vs. rest of USA"}
df_us_ny %>%
    ggplot(aes(x = date, y = death, color = is_ny)) +
    geom_line() +
    theme_bg()
```

```{r, fig.cap="Number of of new positive cases each day in NY vs. rest of USA"}
df_us_ny %>%
    ggplot(aes(x = date, y = positive_change, color = is_ny)) +
    geom_smooth() +
    geom_point() +
    theme_bg()
```

```{r, fig.cap="Number of new deaths each day in NY vs. rest of USA"}
df_us_ny %>%
    ggplot(aes(x = date, y = death_change, color = is_ny)) +
    geom_smooth() +
    geom_point() +
    theme_bg()
```

```{r, fig.cap="Number of deaths per positive cases in NY vs. rest of USA"}
df_us_ny %>%
    filter(death_positive > 0) %>%
    ggplot(aes(x = date, y = death_positive, color = is_ny)) +
    geom_line() +
    theme_bg()
```

